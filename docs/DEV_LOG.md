# Development Log: DocOrchestrator

## 2025-12-19: Запуск и архитектурный фундамент

### Контекст дня
- Начало работы над проектом. Переход от идеи к работающему прототипу.
- Решение технических проблем с растрированием на Windows: полный отказ от внешних зависимостей (Ghostscript/Canvas) в пользу стека **pdfjs-dist + @napi-rs/canvas + WASM**.
- Успешная интеграция с локальным сервером LM Studio (OpenAI API compatible).

### Ключевые достижения
1. **Ingestor & Rasterizer**: 
   - Реализована бесшовная обработка как одиночных PDF, так и папок-контейнеров (один документ = набор файлов). 
   - Решена проблема отрисовки кириллических шрифтов (Tahoma) в среде Node.js через `standardFontDataUrl` и флаг `disableFontFace`.
   - Выбран формат **WebP** (lossless для 300dpi) как оптимальный стандарт для подачи изображений в VLM.
2. **VLM Connection**:
   - Налажен стабильный мост с Qwen3-VL 2B. Модель успешно прошла тест на классификацию паспорта РФ.
   - Отработан протокол передачи изображений через чистый Base64 (решена проблема ошибки HTTP 400 в LM Studio).
3. **Segmenter/Splitter**:
   - Обнаружена и решена проблема "комбо-сканов" (несколько документов на одном листе).
   - Проведены сравнительные тесты координат: **Qwen3-VL 8B** показала прецизионную точность в определении `bbox` (координаты с точностью до 0.1%), что позволяет делать "умную нарезку" через Sharp.
4. **Atomic Orchestrator**:
   - Спроектирована структура управления стадиями через `root.json` (флаги `enabled` и `priority`).
   - Внедрена архитектура "Контекст-Артефакт": каждый атом проверяет наличие готовых данных в `staging` перед запуском.

### Технические решения и идеи
- **No Tesseract**: Принято стратегическое решение исключить классический OCR. Визуальный контекст VLM (Qwen3/SAGE) дает более высокую точность на сложных юридических документах.
- **Reference Testing**: Спроектирован модуль `evaluate`. Система будет автоматически сравнивать JSON от ИИ с эталонным (Ground Truth) для замера Accuracy в процентах.
- **Hardware Path**: Текущая разработка ведется на GTX 1660 6Gb (квантованные модели 2B/4B). Целевая платформа — **RTX 5060 Ti 16Gb** для запуска SAGE-MM 4B и Qwen3 8B в высоком качестве (f16/Q8).

### Планы на завтра
- Тестирование модели **SAGE-MM-Qwen3-VL-4B-SFT_RL** (Allen AI) как основного экстрактора данных.
- Программная реализация атомарного модуля `src/stages/splitter.js` для автоматической нарезки документов по координатам.
- Разбор образцов документов по работе с должниками: ЕГРЮЛ, ЕГРИП, ЕГРН. Описание их полей и правил верификации (ИНН, ОГРН).
