# IDEAS.md — копилка идей DocOrchestrator

Этот файл — список идей, гипотез и будущих улучшений, которые всплывали в обсуждениях, но не обязательно реализуются в ближайшем MVP.

## Легенда

- **Статус**: idea (идея), planned (запланировано), later (позже), research (исследование), maybe (под вопросом).
- **Цель**: зачем идея нужна (качество, скорость, надежность, удобство).
- **Риск**: что может пойти не так.

---

## 1) Маршрутизация, фазы, планировщик

### 1.1 Фазовый прогон моделей (batch-by-stage)

**Статус**: later  
**Цель**: не держать быструю и старшую модель одновременно; прогонять документы «волнами» (сначала все router, затем все extract) для слабого железа.  
**Идея**:

- Фаза A: загрузить быструю модель (router) → прогнать классификацию/детектор → выгрузить.
- Фаза B: загрузить старшую модель (extractor) → прогнать split/extract → выгрузить.

### 1.2 Эвристика small-batch: пропуск fast-роутера

**Статус**: later  
**Цель**: если документов мало (2–3), то выгоднее сразу грузить старшую модель, чем тратить время на загрузку/перегрузку быстрой.  
**Замечание**: критерии small-batch (по docCount/pageCount) должны быть конфигурируемыми.

### 1.3 Ветвление пайплайна по docType

**Статус**: planned  
**Цель**: по-разному обрабатывать разные типы документов (DPI, preprocessing, модель, ретраи).

---

## 2) DPI и «пирамида разрешений»

### 2.1 Пирамида DPI (100/150/200/250/300) на этапе разработки

**Статус**: research  
**Цель**: найти «точку перегиба» — минимальный DPI, дающий 100% точность для конкретного docType (ускорение в разы).  
**Идея**: растеризовать сразу несколько DPI и сохранять артефакты, чтобы прогонять извлечение/валидацию на каждом.

### 2.2 Выбор DPI по типу документа

**Статус**: planned  
**Цель**: простые типы документов (или крупный шрифт) часто можно стабильно извлекать на 100–150 DPI, экономя время и VRAM.  
**Идея**: в `docTypes/*.json` хранить `preferred_dpi` и fallback-стратегию (например 150 → 200 → 300 при провале валидации).

---

## 3) Предобработка изображений

### 3.1 Отдельная стадия Preprocess/Enhancer

**Статус**: later  
**Цель**: поднять точность распознавания (особенно на шумных сканах) при относительно дешевой CPU-стоимости по сравнению с VLM.  
**Кандидаты-операции**:

- deskew/поворот/выравнивание;
- усиление контраста/нормализация;
- шумоподавление;
- (опционально) бинаризация для «мелкого текста».

### 3.1.1 Каскадный deskew: VLM + CV

**Статус**: research  
**Цель**: повысить стабильность ориентации и читаемости небольших документов (паспорт, ВУ, СТС и т.п.), особенно для мелкого текста (VIN, номера).  
**Идея**:

- Быстрая VLM (router) грубо определяет поворот документа (0/90/180/270 градусов).
- Изображение поворачивается до «правильной» стороны.
- Классическая CV-библиотека (например, OpenCV) дорабатывает небольшой наклон (±5°) с помощью алгоритма deskew.
- Для сложных случаев (сильные перспективные искажения) возможен отдельный режим «aggressive deskew».

**Риск**: дополнительные вычисления; требуется аккуратная калибровка, чтобы не портить уже ровные изображения и не вносить артефакты.

### 3.2 Скоринг качества изображения и авто-режимы

**Статус**: research  
**Цель**: автоматически определять «плохие» изображения и выбирать агрессивную предобработку.  
**Идея**: вычислять метрики резкости/энтропии/контраста и по порогам выбирать режим.

### 3.3 Несколько режимов предобработки + выбор лучшего

**Статус**: later  
**Цель**: в тестовом/«ночном» режиме прогонять несколько вариантов (raw, contrast, denoise, deskew…) и выбирать лучший по валидации и/или по метрикам качества.  
**Замечание**: это особенно полезно, когда время не критично, а точность важнее.

---

## 4) Split/Segmenter (совмещенные документы)

### 4.1 Детектор «комбо-сканов» на ранней фазе

**Статус**: later  
**Цель**: определять, что на одном листе несколько документов.

### 4.2 Splitter: bbox → нарезка → новые под-документы

**Статус**: later  
**Цель**: поддержка листов, где несколько документов (паспорт+ВУ и т.п.) с преобразованием одного листа в несколько отдельных сущностей документа.  
**Идея**: VLM возвращает bbox; библиотека обработки изображений режет; оркестратор кладет sub-docs в staging и прогоняет их как обычные документы.

---

## 5) Точность, проверка, ретраи

### 5.1 Валидация/нормализация/верификация кодом (domain rules)

**Статус**: planned  
**Цель**: качество данных достигается не только моделью, но и детерминированными правилами.  
**Примеры**:

- форматы дат, паспортных серий/номеров;
- контрольные суммы/доменные проверки (где применимо);
- согласованность полей (например, дата выдачи не позже текущей).

### 5.2 Повторный запрос модели (retry) при провале валидации

**Статус**: planned  
**Цель**: «дожимать» результат до корректного JSON и повышать точность без ручного вмешательства.  
**Идея**: валидатор формирует короткий "fix prompt": «Исправь только поля X/Y, формат такой-то, JSON-only».

### 5.3 Таблица типичных OCR/VLM-ошибок + автопатчи

**Статус**: later  
**Цель**: исправлять типичные путаницы символов (O/0, I/1, В/8…) только при провале валидации и только в релевантных полях.

---

## 6) Референсы, тестирование, регрессии

### 6.1 Ground Truth dataset + автоматическая оценка (Evaluator)

**Статус**: planned  
**Цель**: измеримость, борьба «за каждый процент» и защита от регрессий при смене модели/промпта/предобработки.

### 6.2 Матрица экспериментов: модели × DPI × preprocess × промпты

**Статус**: research  
**Цель**: комплексно сравнивать варианты и выбирать оптимальные профили под каждый docType.  
**Идея**: запускать сериями и сохранять таблицы результатов (accuracy, время, причины ошибок).

### 6.3 Бенчмарк не только точности, но и времени на каждом шаге

**Статус**: planned  
**Цель**: оптимизация под слабые ПК (1060/FX и т.п.) требует точной картины, где тратится время.  
**Идея**: тайминг каждого атома + агрегаты по документу/типу/модели/DPI.

---

## 7) Хранилище и «JSON-first без БД»

### 7.1 JSON как единое хранилище конфигов и артефактов

**Статус**: planned  
**Цель**: простота, переносимость, кэшируемость, отсутствие зависимости от БД.

### 7.2 Атомарная запись JSON, версия схем, миграции

**Статус**: later  
**Цель**: надежность при падениях/прерываниях и аккуратное изменение форматов конфигов/артефактов.

---

## 8) UI/админка (когда созреет)

### 8.1 Админка для управления конфигами и прогонами

**Статус**: maybe  
**Цель**: удобная настройка без ручного редактирования JSON, запуск тестов, сравнение профилей.

---

## 9) Производительность и «слабое железо»

### 9.1 Дизайн под GTX 1060 6Gb / AMD FX / DDR3

**Статус**: planned  
**Цель**: система должна оставаться полезной даже на слабом железе, пусть и медленнее.  
**Направления**:

- строгая фазовость (не держать две модели);
- минимум лишних проходов по диску;
- кэширование артефактов (не пересчитывать при повторе);
- лимиты параллелизма для CPU-стадий.

---

## 10) Типы документов и предметная область

### 10.1 Поддержка юридических выписок (ЕГРЮЛ/ЕГРИП/ЕГРН) под кейсы должников

**Статус**: planned  
**Цель**: извлечение сущностей/полей из сложных многостраничных документов.  
**Идея**: docType-конфиги должны описывать поля, подсказки и правила верификации.

---

## 11) Модели и стратегия выбора

### 11.1 Сравнение моделей и режимов (fast router + heavy extractor)

**Статус**: planned  
**Цель**: держать возможность тестировать разные модели и выбирать победителей по метрикам точности/скорости.  
**Замечание**: конечная база определяется эмпирически (Evaluator + time).
