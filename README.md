# DocOrchestrator (doc-orchestrator)

DocOrchestrator — это config-first оркестратор обработки документов: конвейер для растрирования PDF, сегментации страниц, определения типа документа и извлечения полей данных с использованием локальных VLM. Система включает усиленную валидацию, нормализацию и верификацию результатов в структурированный JSON.

## Зачем это нужно

Цель проекта — превратить "папку со сканами" в воспроизводимый, расширяемый и измеримый процесс извлечения данных: документ → тип → набор полей → проверенный результат.

Проект ориентирован на работу в закрытом контуре (local-first): модели (LM Studio/Ollama), обработка и артефакты находятся локально, гарантируя безопасность персональных данных.

## Ключевые принципы

- **VLM-First (No OCR)**: Полный отказ от классического OCR (Tesseract) в пользу визуального понимания моделей (Qwen3-VL, SAGE-MM).
- **Конфигурация важнее кода**: Типы документов, модели, папки и этапы задаются через JSON.
- **Атомарность и автономность**: Каждая стадия (атом) независима, отключаема и проверяет наличие необходимых артефактов перед запуском.
- **Достоверность через верификацию**: Сочетание гибкости ИИ с детерминированной проверкой данных кодом (контрольные суммы, регулярные выражения, бизнес-логика).
- **Измеримость**: Встроенная система референсного тестирования для замера точности (Accuracy) на эталонных датасетах.

## Возможности

- **Интеллектуальный Ingest**: Обработка PDF и папок-контейнеров, растрирование в WebP (300 DPI для экстракции, 100 DPI для роутинга).
- **Segmenter (Splitter)**: Обнаружение и нарезка нескольких документов на одном листе (например, Паспорт + ВУ) с помощью VLM координат (`bbox`).
- **Classifier**: Автоматическое определение типа документа на базе списка из `config/docTypes/`.
- **Extractor**: Извлечение данных по динамическим промптам с поддержкой сложных выписок (ЕГРЮЛ, ЕГРН) и таблиц.
- **Evaluator**: Автоматическое сравнение результатов с Ground Truth JSON для оценки качества моделей и предобработки.

## Стек технологий

- **Runtime**: Node.js v22 (Native Fetch, ESM)
- **PDF Engine**: `pdfjs-dist` + `@napi-rs/canvas` (WASM/NAPI рендеринг без внешних зависимостей типа Ghostscript)
- **Image Processing**: `sharp` (высокоскоростная обработка WebP и кроппинг)
- **Inference**: LM Studio / Ollama (OpenAI API compatible)
- **Target Models**: Qwen3-VL (2B/8B), SAGE-MM (4B)

## Дорожная карта (MVP)

- [x] **Шаг 1**: Обнаружение документов + растрирование (100/300 DPI) в WebP с поддержкой кириллицы.
- [ ] **Шаг 2**: Splitter — сегментация нескольких документов на одном скане через VLM координаты.
- [ ] **Шаг 3**: Классификация документов (Router VLM) и обновление манифестов.
- [ ] **Шаг 4**: Извлечение полей основной VLM + строгая валидация и верификация кодом.
- [ ] **Шаг 5**: Тестовый раннер (Evaluator) для замера точности и админка конфигураций.

## Структура конфигурации

- `config/root.json` — управление пайплайном, путями и моделями.
- `config/docTypes/*.json` — реестр типов документов, список полей и промпты извлечения.
- `test_suite/` — эталонные JSON-файлы для автоматического тестирования точности.

## Лицензия

Проект распространяется под лицензией [Apache License 2.0](LICENSE).

## Автор

Создан и поддерживается [AlexanderKuzikov](https://github.com/AlexanderKuzikov).
